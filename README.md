(by Amazon Q CLI)

# Amazon Unaffiliate

Amazonのアフィリエイトリンクからアフィリエイトタグを自動的に削除し、クリーンなURLでアクセスするためのChrome拡張機能です。

## 機能

この拡張機能は、以下の機能を提供します：

- Amazonの商品ページURLからアフィリエイトタグ（`tag=XXXX-22`形式）を削除
- 商品ページのURLから不要なクエリパラメータを削除し、シンプルな形式（`/dp/商品ID/`）に変換
- ページ内のAmazonリンクを自動的にクリーンなURLに変換
- URL短縮サービス（amzn.toなど）経由のリンクも処理

## 動作の仕組み

この拡張機能は、以下の3つの方法でAmazonのアフィリエイトリンクを処理します：

### 1. declarativeNetRequestによるURLの書き換え

ブラウザがAmazonのURLにリクエストを送信する前に、declarativeNetRequestルールによってURLが書き換えられます。これにより、アフィリエイトリンクにアクセスする前に、クリーンなURLにリダイレクトされるため、アフィリエイトとしてカウントされることはありません。

具体的には：
- `tag=XXXX-22`形式のパラメータを削除するルール
- 商品ページのURLを`/dp/商品ID/`形式に変換するルール
- `/gp/product/`形式のURLも適切に処理するルール

を定義しています。

### 2. コンテンツスクリプトによるページ内リンクの処理

ページ内のAmazonリンクは、コンテンツスクリプトによって事前に処理されます。ページが読み込まれた時点で、すべてのリンクをスキャンし、Amazonのアフィリエイトリンクを検出して、クリーンなURLに変換します。

また、MutationObserverを使用して、ページに動的に追加されるリンクも監視し、処理します。

### 3. クリックイベントのインターセプト

ユーザーがAmazonリンクをクリックすると、ブラウザがリクエストを処理する前に、クリックイベントをインターセプトし、クリーンなURLに変換します。これにより、ページ内のリンク処理が漏れた場合でも、確実にクリーンなURLでアクセスできます。

## インストール方法

### 開発版をインストール

1. このリポジトリをクローンまたはダウンロード
2. Chromeブラウザで `chrome://extensions/` を開く
3. 右上の「デベロッパーモード」を有効にする
4. 「パッケージ化されていない拡張機能を読み込む」をクリックする
5. ダウンロードしたディレクトリを選択する

## 技術的な詳細

### 使用技術
- Manifest V3を使用したChrome拡張機能
- declarativeNetRequestによるURLリダイレクト
- コンテンツスクリプトによるページ内リンク処理
- バックグラウンドサービスワーカーによる統計情報の管理
- MutationObserverによる動的コンテンツの監視

### 主要なコンポーネント

#### 1. declarativeNetRequest ルール (rules.json)
- ブラウザのリクエスト前にURLを書き換えるルールを定義
- アフィリエイトタグ（`tag=XXXX-22`）を削除するルール
- 商品ページURLを正規表現で検出し、クリーンな形式（`/dp/商品ID/`）に変換
- これにより、ブラウザがアフィリエイトリンクにアクセスする前に、クリーンなURLにリダイレクト

#### 2. バックグラウンドスクリプト (background.js)
- 拡張機能の中核となる処理を担当
- declarativeNetRequestのルールマッチを監視し、統計情報を更新
- コンテンツスクリプトからのメッセージを処理
- URLの解析と変換のロジックを提供

#### 3. コンテンツスクリプト (content.js)
- ページ読み込みの最初期段階（`document_start`）で実行
- ページ内のすべてのAmazonリンクを検出し、クリーンなURLに変換
- クリックイベントをキャプチャフェーズでインターセプトし、リンクを処理
- MutationObserverを使用して、動的に追加されるリンクも監視
- 定期的にページをスキャンして、未処理のリンクを検出

#### 4. ポップアップUI (popup.html, popup.js)
- 拡張機能の状態と統計情報を表示
- 現在のページを手動でクリーンにする機能を提供
- デバッグ情報の表示

## プライバシーポリシー

この拡張機能は：
- ユーザーのブラウジングデータを収集しません
- 外部サーバーと通信しません
- 広告を表示しません
- ユーザーのデータを第三者と共有しません

唯一の目的は、Amazonのアフィリエイトリンクからアフィリエイトタグを削除し、クリーンなURLでアクセスすることです。

## ライセンス

MIT License
## 使用例

### アフィリエイトリンクの変換例

以下のようなアフィリエイトリンクがあった場合：
(ここではtag、linkIdをxxxxにしているので無効)

```
https://www.amazon.co.jp/%E3%82%B3%E3%83%BC%E3%83%81%E3%83%B3%E3%82%B0%E3%81%AE%E3%81%99%E3%81%B9%E3%81%A6%E2%80%95%E2%80%95%E3%81%9D%E3%81%AE%E6%88%90%E3%82%8A%E7%AB%8B%E3%81%A1%E3%83%BB%E6%B5%81%E6%B4%BE%E3%83%BB%E7%90%86%E8%AB%96%E3%81%8B%E3%82%89%E5%AE%9F%E8%B7%B5%E3%81%AE%E6%8C%87%E9%87%9D%E3%81%BE%E3%81%A7-%E3%82%B8%E3%83%A7%E3%82%BB%E3%83%95-%E3%82%AA%E3%82%B3%E3%83%8A%E3%83%BC/dp/4862761526/ref=as_li_ss_tl?ie=UTF8&qid=1522382585&sr=8-12&keywords=%E3%82%B3%E3%83%BC%E3%83%81%E3%83%B3%E3%82%B0&linkCode=sl1&tag=xxxx&linkId=xxxx
```

この拡張機能を使用すると、以下のようなクリーンなURLに変換されます：

```
https://www.amazon.co.jp/dp/4862761526/
```

### 短縮URLの処理

Amazon短縮URL（例：`https://amzn.to/xxxx`）も同様に処理され、リダイレクト先のクリーンなURLに変換されます。

## 詳細な動作フロー

1. **ブラウザがURLにアクセスする前の処理**
   - ユーザーがAmazonのアフィリエイトリンクをクリックする
   - declarativeNetRequestルールがURLを検査し、アフィリエイトタグを含むかチェック
   - アフィリエイトタグが検出された場合、タグを削除したクリーンなURLに書き換え
   - 商品ページURLの場合、`/dp/商品ID/`形式のシンプルなURLに変換
   - ブラウザは元のURLではなく、クリーンなURLにアクセス

2. **ページ内のリンク処理**
   - ページが読み込まれると、コンテンツスクリプトが実行される
   - ページ内のすべてのリンクをスキャンし、Amazonのリンクを検出
   - 検出されたAmazonリンクをクリーンなURLに変換
   - MutationObserverを使用して、ページに動的に追加されるリンクも監視

3. **ユーザーのクリック時の処理**
   - ユーザーがページ内のAmazonリンクをクリックする
   - コンテンツスクリプトがクリックイベントをキャプチャ
   - リンクのURLをチェックし、アフィリエイトタグが含まれている場合は削除
   - クリーンなURLに変換してからナビゲーション

これらの3つの層による保護により、アフィリエイトリンクが確実に処理され、ユーザーは常にクリーンなURLでAmazonにアクセスできます。
